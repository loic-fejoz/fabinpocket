(function(H){const a=16;function R(){this.timeTable=[];this.currentTimeTableIndex=0;this.totalTime=a;for(var ac=0;ac<a;ac++){this.timeTable[ac]=1}this.averageFPS=0}R.prototype.update=function(ac){ac=ac*0.001;this.totalTime=this.totalTime+ac-this.timeTable[this.currentTimeTableIndex];this.timeTable[this.currentTimeTableIndex]=ac;this.currentTimeTableIndex=(this.currentTimeTableIndex+1)%a;this.averageFPS=Math.floor((1/(this.totalTime/a))+0.5)};var Z=new R();var x={zScale:1};document.FabInPocket=x;var C=x.glcanvas=document.getElementById("previewcanvas");var K;var Y;function E(ad,ac){ad.push(ac.x);ad.push(ac.y);ad.push(ac.z)}function F(ac,ad){if(ad[0].z>0||ad[1].z>0||ad[2].z>0){E(ac,ad[0]);E(ac,ad[1]);E(ac,ad[2]);E(ac,{x:ad[0].x,y:ad[0].y,z:0});E(ac,{x:ad[2].x,y:ad[2].y,z:0});E(ac,{x:ad[1].x,y:ad[1].y,z:0})}}function V(ac,ad){F(ac,[ad[0],ad[3],ad[1]]);F(ac,[ad[0],ad[2],ad[3]])}var P=document.getElementById("shapecanvas");var o=undefined;var l=document.getElementById("heightmap");function O(ac,ad,ak){const ag=Number.POSITIVE_INFINITY;var ae=new Array(ac.length);for(var aj=0;aj<ad.width;aj++){if(ac[aj]<=ak){ae[aj]=0}else{ae[aj]=ag}var af;for(var ai=1;ai<ad.height;ai++){af=aj+(ai*ad.width);if(ac[af]<=ak){ae[af]=0}else{ae[af]=1+ae[aj+(ai-1)*ad.width]}}var ah;for(var ai=ad.height-2;ai>=0;ai--){af=aj+(ai*ad.width);ah=aj+((ai+1)*ad.width);if(ae[ah]<ae[af]){ae[af]=1+ae[ah]}}}return ae}function n(ag,af,ah,ai,ae){var ac=ah[af+ai*ae.width];var ad=ah[ag+ai*ae.width];return Math.floor((af*af-ag*ag+ac*ac-ad*ad)/(2*(af-ag)))}function T(ae,af,ag,ah){var ad=new Array(ae.length);var ac=0;var am=new Array(af.width);var al=new Array(af.width);for(var ai=0;ai<af.height;ai++){ac=0;am[0]=0;al[0]=0;for(var ak=1;ak<af.width;ak++){while(ac>=0&&(ah(al[ac],am[ac],ai)>ah(al[ac],ak,ai))){ac--}if(ac<0){ac=0;am[0]=ak}else{var aj=1+n(am[ac],ak,ag,ai,af);if(aj<af.width){ac++;am[ac]=ak;al[ac]=aj}}}for(var ak=af.width-1;ak>=0;ak--){ad[ak+(ai*af.width)]=Math.sqrt(ah(ak,am[ac],ai));if(ak==al[ac]){ac--}}}return ad}function Q(ah,ad,ac){var af=O(ah,ad,ac);var ag=function ae(ai,ak,al){var aj=af[ak+al*ad.width];return(ai-ak)*(ai-ak)+aj*aj};return T(ah,ad,af,ag)}function c(ad,ac,af,aj,ai){var ag=0;var ae=aj+(ai*af.width);var al=ac[ae];if(ad[ae]===0){return false}for(var an=-1;an<=1;an++){for(var am=-1;am<=1;am++){if(an===0&&am===0){continue}var ah=(aj+an)+((ai+am)*af.width);var ak=ac[ah];if(ak>al){ag+=1}}}return(ag<1)}function M(ad,ac,ah,ae){var ai=ah.width+ah.height;var ag=ae.length;while(ag--){ae[ag]=ai}for(var aj=1;aj<(ah.height-2);aj++){for(var ak=1;ak<(ah.width-2);ak++){var af=ak+(aj*ah.width);if(c(ad,ac,ah,ak,aj)){ae[af]=0}}}}function u(al,ai,aj){var ad=document.getElementById("computedheightmapcanvas");ad.width=ai.width;ad.height=ai.height;var ai=new Image();ai.src=l.src;var an=ad.getContext("2d");var am=new Array(al.length);var ao=0;var am=Q(al,ai,ao);var ah=al.length;var af=new Array(al.length);M(al,am,ai,af);var af=Q(af,ai,0);var ae=0;var ac=an.getImageData(0,0,ai.width,ai.height);var ag=ac.data;ah=al.length;while(ah--){var ak=am[ah];ak=Math.sqrt((am[ah]+af[ah])*(am[ah]+af[ah])-(af[ah]*af[ah]));if(ak>ae){ae=ak}ak=aj*al[ah]/255*ak;ag[4*ah]=ak;ag[(4*ah)+1]=(af[ah]===0&&al[ah]!==0)?255:ak;ag[(4*ah)+2]=(af[ah]===0&&al[ah]!==0)?0:ak;ag[(4*ah)+3]=255}console.log("longest distance found: "+ae);an.putImageData(ac,0,0)}function i(ak,ag){if(ag===undefined){return}var ad=ak.getContext("2d");var ac=ad.getImageData(0,0,ag.width,ag.height);var ae=ac.data;var ai=x.zScale;var aj=new Array();for(var af=0;af<ae.length;af+=4){var ah=ai*ae[af];aj.push(ah);if(o==undefined||ah>o){o=ah}}return aj}function j(ag,af){var ak=af.width/2;var aj=af.height/2;var ai="";ai+="solid fabinpocket\n";var ae=0;while(ae<ag.length){ai+=" facet normal 0.0 0.0 0.0\n  outer loop\n";ai+="    vertex "+(ak+ag[ae])+" "+(aj+ag[ae+1])+" "+ag[ae+2]+"\n";ae+=3;ai+="    vertex "+(ak+ag[ae])+" "+(aj+ag[ae+1])+" "+ag[ae+2]+"\n";ae+=3;ai+="    vertex "+(ak+ag[ae])+" "+(aj+ag[ae+1])+" "+ag[ae+2]+"\n";ae+=3;ai+="  endloop\n endfacet\n"}ai+="ensolid fabinpocket\n";var ah=document.getElementById("export-stl");var ac=new Blob([ai],{type:"octet/stream"});var ad=window.URL.createObjectURL(ac);ah.setAttribute("href",ad)}H("#export-stl").on("click",function(){j(d,m)});function s(){var ac=document.getElementById("export-png");var ad=document.getElementById("computedheightmapcanvas");ac.href=ad.toDataURL("image/png")}H("#export-png").on("click",function(){s()});function B(){var ac=document.getElementById("export-shape");var ad=document.getElementById("shapecanvas");ac.href=ad.toDataURL("image/png")}H("#export-shape").on("click",function(){B()});function w(ag,ac){var ad=P.getContext("2d");if(ac){ag.src=l.src;P.width=ag.width;P.height=ag.height;ad.drawImage(ag,0,0);x.zScale=parseFloat(document.getElementById("heightmap").getAttribute("z-scale"));if(x.zScale===undefined){x.zScale=1}}o=undefined;var ak=i(P,ag);var ai=x.zScale;console.log("zScale="+ai);u(ak,ag,ai);ak=i(document.getElementById("computedheightmapcanvas"),ag);var aj=new Array();for(var al=0;al<(ag.height-1);al++){for(var am=0;am<(ag.width-1);am++){var an=ak[am+(al*ag.width)];var af=ak[am+1+(al*ag.width)];var ah=ak[am+((al+1)*ag.width)];var ae=ak[am+1+((al+1)*ag.width)];V(aj,[{x:am-ag.width/2,y:ag.height/2-al,z:an},{x:am+1-ag.width/2,y:ag.height/2-al,z:af},{x:am-ag.width/2,y:ag.height/2-al-1,z:ah},{x:am+1-ag.width/2,y:ag.height/2-al-1,z:ae}])}}if(aj.length===0){aj=undefined}return aj}var v=480/640;var k;var d;var m;var D=new THREE.Scene();var t=new THREE.PerspectiveCamera(75,600/400,0.1,50000);var L=new THREE.WebGLRenderer({canvas:C});var r=new THREE.BoxGeometry(1,1,1);var S=new THREE.MeshPhongMaterial({color:6842506,ambient:16777215,shininess:30,reflectivity:30});var b=new THREE.Mesh(r,S);var z=undefined;function X(ae){d=[-1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,-1,-1,1,1,-1];var af=ae?new Image():m;var ac=w(af,ae);if(ac!==undefined){d=ac}r=new THREE.BufferGeometry();var ag=new Float32Array(d.length);for(var ad=0;ad<d.length;ad++){ag[ad]=d[ad]}r.addAttribute("position",new THREE.BufferAttribute(ag,3));r.computeFaceNormals();r.computeVertexNormals();r.computeBoundingBox();if(z!=undefined){D.remove(z)}z=new THREE.Mesh(r,S);z.castShadow=true;z.receiveShadow=true;z.position.x-=z.position.x/2;z.position.y-=z.position.y/2;D.add(z);m=af}function N(){var ad=document.getElementById("preview-wrapper");var ae=ad.offsetWidth;var ac=ad.offsetHeight;L.setSize(ae,ac);t.aspect=ae/ac}H(window).resize(N);var h;function U(){N();L.setClearColor(16777215,1);L.shadowMapEnabled=true;D.add(b);var ae=new THREE.PlaneBufferGeometry(640,400);var af=new THREE.MeshPhongMaterial({color:15724527});var ad=new THREE.Mesh(ae,af);ad.castShadow=true;ad.receiveShadow=true;ad.receiveShadow=true;D.add(ad);var ac=new THREE.AmbientLight(4210752);D.add(ac);h=new THREE.SpotLight(16777215);h.position.set(0,0,100);h.castShadow=true;h.shadowDarkness=0.5;h.castShadow=true;h.shadowMapWidth=512;h.shadowMapHeight=512;h.intensity=1;h.shadowDarkness=0.1;h.shadowCameraNear=true;D.add(h);t.position.x=5;t.position.y=5;t.position.z=5;t.up.set(0,0,1);t.lookAt(new THREE.Vector3(0,0,0));X(true);f(performance.now())}var G=undefined;var J=new Float32Array([0,0,1]);var W=new Float32Array(16);var e=new Float32Array(16);var A=new Float32Array([0,0,255]);var g=new Float32Array([0,0,0]);var q=new Float32Array(16);var ab=new Float32Array(16);var p=new Float32Array(16);var aa;var I=0.02;var y=undefined;function f(ad){x.stopLoop=window.requestAnimationFrame(f);if(m===undefined){return}var ac;if(G==undefined){ac=1}else{ac=ad-G}G=ad;var ae=(new Date()).getTime();var ag=ae-aa;aa=ae;Z.update(ac);document.getElementById("fps").innerHTML=Z.averageFPS;var af=(P.clientWidth+P.clientHeight+o)/3;af=(m.width+m.height+o)/3;af=af/3;if(z!=undefined&&z.geometry!=undefined){z.geometry.computeBoundingSphere();af=z.geometry.boundingSphere.radius}t.position.x=Math.sin(ad*0.0003)*1*af;t.position.y=Math.cos(ad*0.0003)*1*af;t.position.z=1.5*af;t.lookAt(new THREE.Vector3(0,0,0));h.position.z=5*af;L.render(D,t)}document.fabinpocketInit=U;document.fabinpocketUpdate3D=X;document.addEventListener("DOMContentLoaded",U)})(jQuery);(function(d){function b(f){console.log("Updating...");d("#loading-container").addClass("fa fa-spinner fa-spin");document.fabinpocketUpdate3D(f);d("#loading-container").removeClass("fa fa-spinner fa-spin")}function c(){b(false)}var a=undefined;function e(){if(a!==undefined){window.clearTimeout(a)}a=window.setTimeout(c,750)}d(document).ready(function(){d("#heightmap").on("load",function(){b(true)});d(".tabs__tab").click(function(m){d(".tabs__tab").removeClass("is-active");d(this).addClass("is-active");d(".tabs__panel").removeClass("is-active");d(d(this).attr("href")).addClass("is-active");m.preventDefault();return false});d("#menu-button").click(function(m){d(".menu").toggleClass("is-active");m.preventDefault();return false});var k=window.URL||window.webkitURL;d("#file-upload").change(function(o){var m=d(this).val();var n=this.files[0];console.log("loading new image: "+m);d("#heightmap").attr("src",k.createObjectURL(n));d("#heightmap").each(function(){if(this.complete){b(true)}else{console.log("not complete")}});d(".menu").toggleClass("is-active")});d("#white-pencil-btn").click(function(m){g.color="white";d(".menu").toggleClass("is-active");m.preventDefault();return false});d("#black-eraser-btn").click(function(m){g.color="black";d(".menu").toggleClass("is-active");m.preventDefault();return false});d("#clear-btn").click(function(m){d(".menu").toggleClass("is-active");var n=d("#shapecanvas")[0];var o=n.getContext("2d");o.fillStyle="black";o.fillRect(0,0,n.width,n.height);e();m.preventDefault();return false});var i={};var j=d("#shapecanvas")[0].getContext("2d");function h(o){var m=d("#shapecanvas")[0];var n=m.getBoundingClientRect();o.canvasX=o.offsetX*m.width/n.width;o.canvasY=o.offsetY*m.height/n.height}var g={size:10,color:"white",start:function(m){h(m);f(j,m);j.beginPath();j.lineWidth=g.size;j.fillStyle=g.color;j.strokeStyle=g.color;j.moveTo(m.canvasX,m.canvasY);i.started=true;e();m.preventDefault()},move:function(m){if(i.started){h(m);j.lineTo(m.canvasX,m.canvasY);j.stroke();e();m.preventDefault()}},end:function(m){if(i.started){h(m);j.lineTo(m.canvasX,m.canvasY);j.stroke();f(j,m);e();m.preventDefault()}i.started=false}};function f(n,o){var m=g.size/2;n.moveTo(o.canvasX,o.canvasY);n.beginPath();n.lineWidth=1;n.fillStyle=g.color;n.strokeStyle=g.color;n.arc(o.canvasX,o.canvasY,m,0,2*Math.PI,true);n.fill()}var l=d("#shapecanvas");l.on("mousedown",g.start).on("touchmove mousemove",g.move).on("touchup mouseup",g.end);l[0].addEventListener("touchstart",g.start);l[0].addEventListener("touchmove",g.move);l[0].addEventListener("touchen",g.end);d("#tool-size").on("change",function(m){g.size=parseFloat(d(this).val())});d("#z-scale").on("change",function(m){document.FabInPocket.zScale=parseFloat(d(this).val());e()})})})(jQuery);