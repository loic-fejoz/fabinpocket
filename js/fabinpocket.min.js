(function(G,C){var s={};var v=s.glcanvas=document.getElementById("previewcanvas");v.width=640;v.height=400;var k=G.webgl.setupWebGL(v);if(!k){alert("Unable to initialize WebGL. Your browser may not support it.")}var E;var R;function F(){E=G.programs.loadProgram(document.getElementById("shader-vs").textContent,document.getElementById("shader-fs").textContent).program;k.useProgram(E);R=k.getAttribLocation(E,"aVertexPosition_modelspace");k.enableVertexAttribArray(R)}function w(V,U){V.push(U.x);V.push(U.y);V.push(U.z)}function x(U,V){if(V[0].z>0||V[1].z>0||V[2].z>0){w(U,V[0]);w(U,V[1]);w(U,V[2]);w(U,{x:V[0].x,y:V[0].y,z:0});w(U,{x:V[2].x,y:V[2].y,z:0});w(U,{x:V[1].x,y:V[1].y,z:0})}}function N(U,V){x(U,[V[0],V[3],V[1]]);x(U,[V[0],V[2],V[3]])}var J=document.getElementById("shapecanvas");var l=undefined;var i=document.getElementById("heightmap");var o=parseFloat(i.getAttribute("z-scale"));function O(Z,W){for(var U=0;U<(W.width-1);U++){for(var ab=0;ab<(W.height-1);ab++){var Y=U+(ab*W.width);var aa=Z[Y];var V=U+((ab+1)*W.width);var X=Z[V];Z[V]=Math.min(aa+1,X)}}}function t(Z,W){for(var V=0;V<(W.width-1);V++){for(var ab=W.height-1;ab>=0;ab--){var Y=V+(ab*W.width);var aa=Z[Y];var U=V+((ab-1)*W.width);var X=Z[U];Z[U]=Math.min(aa+1,X)}}}function K(Y,V){for(var ab=0;ab<(V.height-1);ab++){for(var U=0;U<(V.width-1);U++){var X=U+(ab*V.width);var aa=Y[X];var W=U+1+(ab*V.width);var Z=Y[W];Y[W]=Math.min(aa+1,Z)}}}function S(Y,V){for(var ab=0;ab<(V.height-1);ab++){for(var U=(V.width-1);U>=0;U--){var X=U+(ab*V.width);var aa=Y[X];var Z=U-1+(ab*V.width);var W=Y[Z];Y[Z]=Math.min(aa+1,W)}}}function a(V,U,X,ab,aa){var Y=0;var W=ab+(aa*X.width);var ad=U[W];if(V[W]===0){return false}for(var af=-1;af<=1;af++){for(var ae=-1;ae<=1;ae++){if(af===0&&ae===0){continue}var Z=(ab+af)+((aa+ae)*X.width);var ac=U[Z];if(ac>ad){Y+=1}}}return(Y<1)}function H(V,U,Z,W){var aa=Math.max(Z.width,Z.height);var Y=W.length;while(Y--){W[Y]=aa}for(var ab=1;ab<(Z.height-2);ab++){for(var ac=1;ac<(Z.width-2);ac++){var X=ac+(ab*Z.width);if(a(V,U,Z,ac,ab)){W[X]=0}}}}function y(V,U){O(V,U);t(V,U);K(V,U);S(V,U)}function z(ad,aa,ab){var V=document.getElementById("testcanvas");V.width=aa.width;V.height=aa.height;var aa=new Image();aa.src=i.src;var af=V.getContext("2d");var ae=new Array(ad.length);var ag=0.1;var Z=ad.length;while(Z--){ae[Z]=(ad[Z]>ag)?Math.max(aa.width,aa.height):0}y(ae,aa);var X=new Array(ad.length);H(ad,ae,aa,X);y(X,aa);var W=0;var U=af.getImageData(0,0,aa.width,aa.height);var Y=U.data;Z=ad.length;while(Z--){var ac=ae[Z];ac=Math.sqrt((ae[Z]+X[Z])*(ae[Z]+X[Z])-(X[Z]*X[Z]));if(ac>W){W=ac}ac=ab*ad[Z]/255*ac;Y[4*Z]=ac;Y[(4*Z)+1]=(X[Z]===0&&ad[Z]!==0)?255:ac;Y[(4*Z)+2]=(X[Z]===0&&ad[Z]!==0)?0:ac;Y[(4*Z)+3]=255}console.log("longest distance found: "+W);af.putImageData(U,0,0)}function f(W,V){if(V===undefined){return}var U=W.getContext("2d");var ab=U.getImageData(0,0,V.width,V.height);var aa=ab.data;var Z=new Array();for(var X=0;X<aa.length;X+=4){var Y=o*aa[X];Z.push(Y);if(l==undefined||Y>l){l=Y}}return Z}function g(Y,X){var ac=X.width/2;var ab=X.height/2;var aa="";aa+="solid fabinpocket\n";var W=0;while(W<Y.length){aa+="facet normal 0.0 0.0 0.0\n  outer loop\n";aa+="    vertex "+(ac+Y[W])+" "+(ab+Y[W+1])+" "+Y[W+2]+"\n";W+=3;aa+="    vertex "+(ac+Y[W])+" "+(ab+Y[W+1])+" "+Y[W+2]+"\n";W+=3;aa+="    vertex "+(ac+Y[W])+" "+(ab+Y[W+1])+" "+Y[W+2]+"\n";W+=3;aa+="  endloop\nendfacet\n"}aa+="ensolid\n";var Z=document.getElementById("export-stl");var U=new Blob([aa],{type:"octet/stream"});var V=window.URL.createObjectURL(U);Z.setAttribute("href",V)}function p(){var U=document.getElementById("export-png");var V=document.getElementById("testcanvas");U.href=V.toDataURL("image/png")}function r(X){X.src=i.src;J.width=X.width;J.height=X.height;l=undefined;var U=J.getContext("2d");U.drawImage(X,0,0);var ab=f(J,X);var Z=parseFloat(document.getElementById("heightmap").getAttribute("z-scale"));console.log("zScale="+Z);z(ab,X,Z);ab=f(document.getElementById("testcanvas"),X);var aa=new Array();for(var ac=0;ac<(X.height-1);ac++){for(var ad=0;ad<(X.width-1);ad++){var ae=ab[ad+(ac*X.width)];var W=ab[ad+1+(ac*X.width)];var Y=ab[ad+((ac+1)*X.width)];var V=ab[ad+1+((ac+1)*X.width)];N(aa,[{x:ad-X.width/2,y:X.height/2-ac,z:ae},{x:ad+1-X.width/2,y:X.height/2-ac,z:W},{x:ad-X.width/2,y:X.height/2-ac-1,z:Y},{x:ad+1-X.width/2,y:X.height/2-ac-1,z:V}])}}if(aa.length===0){aa=undefined}return aa}var q=480/640;var h;var b;var j;function Q(){h=k.createBuffer();k.bindBuffer(k.ARRAY_BUFFER,h);b=[-1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,-1,-1,1,1,-1];var V=new Image();var U=r(V);if(U!==undefined){b=U}g(b,V);p();k.bufferData(k.ARRAY_BUFFER,new Float32Array(b),k.STATIC_DRAW);j=V}var I;function L(){j=undefined;if(k){k.viewport(0,0,k.drawingBufferWidth,k.drawingBufferHeight);k.clearColor(0.9,0.9,0.9,1);k.clearDepth(1);k.enable(k.DEPTH_TEST);k.enable(k.CULL_FACE);k.depthFunc(k.LESS);F();Q();I=new G.fps.FPSTimer();d(performance.now())}}var B=undefined;var D=new Float32Array([0,0,1]);var P=new Float32Array(16);var c=new Float32Array(16);var u=new Float32Array([0,0,255]);var e=new Float32Array([0,0,0]);var n=new Float32Array(16);var T=new Float32Array(16);var m=new Float32Array(16);var M=G.fast;var A=G.math;function d(X){s.stopLoop=window.requestAnimationFrame(d);if(j===undefined){return}var V;if(B==undefined){V=0}else{V=(X-B)*0.001}B=X;I.update(V);document.getElementById("fps").innerHTML=I.averageFPS;var Y=(J.clientWidth+J.clientHeight+l)/3;Y=(j.width+j.height+l)/3;u[0]=Math.sin(X*0.0003)*1.5*Y;u[1]=Math.cos(X*0.0003)*1.5*Y;u[2]=Y;k.clear(k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT);M.matrix4.perspective(P,A.degToRad(60),v.clientWidth/v.clientHeight,1,5000);M.matrix4.lookAt(c,u,e,D);M.matrix4.mul(n,c,P);k.bindBuffer(k.ARRAY_BUFFER,h);k.vertexAttribPointer(R,3,k.FLOAT,false,0,0);var U=k.getUniformLocation(E,"uMVMatrix");k.uniformMatrix4fv(U,false,n);var W=k.getUniformLocation(E,"zMax");k.uniform1f(W,l);k.drawArrays(k.TRIANGLES,0,Math.floor(b.length/3))}document.fabinpocketInit=L;document.fabinpocketLoadImage=r;document.addEventListener("DOMContentLoaded",L)})(tdl);(function(a){a(document).ready(function(){a(".tabs__tab").click(function(b){a(".tabs__tab").removeClass("is-active");a(this).addClass("is-active");a(".tabs__panel").removeClass("is-active");a(a(this).attr("href")).addClass("is-active");b.preventDefault();return false});a("#menu-button").click(function(b){a(".menu").toggleClass("is-active");b.preventDefault();return false});a("#file-upload").change(function(c){var b=a(this).val();console.log("loading new image: "+b);a("#heightmap").attr("src",b);document.fabinpocketInit();a(".menu").toggleClass("is-active")})})})(jQuery);