(function(F,B){var s={};var v=s.glcanvas=document.getElementById("previewcanvas");v.width=640;v.height=400;var k=F.webgl.setupWebGL(v);if(!k){alert("Unable to initialize WebGL. Your browser may not support it.")}var D;var Q;function E(){D=F.programs.loadProgram(document.getElementById("shader-vs").textContent,document.getElementById("shader-fs").textContent).program;k.useProgram(D);Q=k.getAttribLocation(D,"aVertexPosition_modelspace");k.enableVertexAttribArray(Q)}function w(U,T){U.push(T.x);U.push(T.y);U.push(T.z)}function x(T,U){if(U[0].z>0||U[1].z>0||U[2].z>0){w(T,U[0]);w(T,U[1]);w(T,U[2]);w(T,{x:U[0].x,y:U[0].y,z:0});w(T,{x:U[2].x,y:U[2].y,z:0});w(T,{x:U[1].x,y:U[1].y,z:0})}}function M(T,U){x(T,[U[0],U[3],U[1]]);x(T,[U[0],U[2],U[3]])}var I=document.getElementById("shapecanvas");var l=undefined;var i=document.getElementById("heightmap");function N(Y,V){for(var T=0;T<(V.width-1);T++){for(var aa=0;aa<(V.height-1);aa++){var X=T+(aa*V.width);var Z=Y[X];var U=T+((aa+1)*V.width);var W=Y[U];Y[U]=Math.min(Z+1,W)}}}function t(Y,V){for(var U=0;U<(V.width-1);U++){for(var aa=V.height-1;aa>=0;aa--){var X=U+(aa*V.width);var Z=Y[X];var T=U+((aa-1)*V.width);var W=Y[T];Y[T]=Math.min(Z+1,W)}}}function J(X,U){for(var aa=0;aa<(U.height-1);aa++){for(var T=0;T<(U.width-1);T++){var W=T+(aa*U.width);var Z=X[W];var V=T+1+(aa*U.width);var Y=X[V];X[V]=Math.min(Z+1,Y)}}}function R(X,U){for(var aa=0;aa<(U.height-1);aa++){for(var T=(U.width-1);T>=0;T--){var W=T+(aa*U.width);var Z=X[W];var Y=T-1+(aa*U.width);var V=X[Y];X[Y]=Math.min(Z+1,V)}}}function y(U,T){N(U,T);t(U,T);J(U,T);R(U,T)}function a(U,T,W,aa,Z){var X=0;var V=aa+(Z*W.width);var ac=T[V];if(U[V]===0){return false}for(var ae=-1;ae<=1;ae++){for(var ad=-1;ad<=1;ad++){if(ae===0&&ad===0){continue}var Y=(aa+ae)+((Z+ad)*W.width);var ab=T[Y];if(ab>ac){X+=1}}}return(X<1)}function G(U,T,Y,V){var Z=Math.max(Y.width,Y.height);var X=V.length;while(X--){V[X]=Z}for(var aa=1;aa<(Y.height-2);aa++){for(var ab=1;ab<(Y.width-2);ab++){var W=ab+(aa*Y.width);if(a(U,T,Y,ab,aa)){V[W]=0}}}}function p(ac,Z,aa){var U=document.getElementById("computedheightmapcanvas");U.width=Z.width;U.height=Z.height;var Z=new Image();Z.src=i.src;var ae=U.getContext("2d");var ad=new Array(ac.length);var af=0.1;var Y=ac.length;while(Y--){ad[Y]=(ac[Y]>af)?Math.max(Z.width,Z.height):0}y(ad,Z);var W=new Array(ac.length);G(ac,ad,Z,W);y(W,Z);var V=0;var T=ae.getImageData(0,0,Z.width,Z.height);var X=T.data;Y=ac.length;while(Y--){var ab=ad[Y];ab=Math.sqrt((ad[Y]+W[Y])*(ad[Y]+W[Y])-(W[Y]*W[Y]));if(ab>V){V=ab}ab=aa*ac[Y]/255*ab;X[4*Y]=ab;X[(4*Y)+1]=(W[Y]===0&&ac[Y]!==0)?255:ab;X[(4*Y)+2]=(W[Y]===0&&ac[Y]!==0)?0:ab;X[(4*Y)+3]=255}console.log("longest distance found: "+V);ae.putImageData(T,0,0)}function f(ab,X){if(X===undefined){return}var U=ab.getContext("2d");var T=U.getImageData(0,0,X.width,X.height);var V=T.data;var Z=parseFloat(document.getElementById("heightmap").getAttribute("z-scale"));var aa=new Array();for(var W=0;W<V.length;W+=4){var Y=Z*V[W];aa.push(Y);if(l==undefined||Y>l){l=Y}}return aa}function g(X,W){var ab=W.width/2;var aa=W.height/2;var Z="";Z+="solid fabinpocket\n";var V=0;while(V<X.length){Z+="facet normal 0.0 0.0 0.0\n  outer loop\n";Z+="    vertex "+(ab+X[V])+" "+(aa+X[V+1])+" "+X[V+2]+"\n";V+=3;Z+="    vertex "+(ab+X[V])+" "+(aa+X[V+1])+" "+X[V+2]+"\n";V+=3;Z+="    vertex "+(ab+X[V])+" "+(aa+X[V+1])+" "+X[V+2]+"\n";V+=3;Z+="  endloop\nendfacet\n"}Z+="ensolid\n";var Y=document.getElementById("export-stl");var T=new Blob([Z],{type:"octet/stream"});var U=window.URL.createObjectURL(T);Y.setAttribute("href",U)}function o(){var T=document.getElementById("export-png");var U=document.getElementById("computedheightmapcanvas");T.href=U.toDataURL("image/png")}function r(X,T){var U=I.getContext("2d");if(T){X.src=i.src;I.width=X.width;I.height=X.height;U.drawImage(X,0,0)}l=undefined;var ab=f(I,X);var Z=parseFloat(document.getElementById("heightmap").getAttribute("z-scale"));console.log("zScale="+Z);p(ab,X,Z);ab=f(document.getElementById("computedheightmapcanvas"),X);var aa=new Array();for(var ac=0;ac<(X.height-1);ac++){for(var ad=0;ad<(X.width-1);ad++){var ae=ab[ad+(ac*X.width)];var W=ab[ad+1+(ac*X.width)];var Y=ab[ad+((ac+1)*X.width)];var V=ab[ad+1+((ac+1)*X.width)];M(aa,[{x:ad-X.width/2,y:X.height/2-ac,z:ae},{x:ad+1-X.width/2,y:X.height/2-ac,z:W},{x:ad-X.width/2,y:X.height/2-ac-1,z:Y},{x:ad+1-X.width/2,y:X.height/2-ac-1,z:V}])}}if(aa.length===0){aa=undefined}return aa}var q=480/640;var h;var b;var j;function P(U){h=k.createBuffer();k.bindBuffer(k.ARRAY_BUFFER,h);b=[-1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,-1,-1,1,1,-1];var V=U?new Image():j;var T=r(V,U);if(T!==undefined){b=T}g(b,V);o();k.bufferData(k.ARRAY_BUFFER,new Float32Array(b),k.STATIC_DRAW);j=V}var H;function K(){j=undefined;if(k){k.viewport(0,0,k.drawingBufferWidth,k.drawingBufferHeight);k.clearColor(0.9,0.9,0.9,1);k.clearDepth(1);k.enable(k.DEPTH_TEST);k.enable(k.CULL_FACE);k.depthFunc(k.LESS);E();P(true);H=new F.fps.FPSTimer();d(performance.now())}}var A=undefined;var C=new Float32Array([0,0,1]);var O=new Float32Array(16);var c=new Float32Array(16);var u=new Float32Array([0,0,255]);var e=new Float32Array([0,0,0]);var n=new Float32Array(16);var S=new Float32Array(16);var m=new Float32Array(16);var L=F.fast;var z=F.math;function d(W){s.stopLoop=window.requestAnimationFrame(d);if(j===undefined){return}var U;if(A==undefined){U=0}else{U=(W-A)*0.001}A=W;H.update(U);document.getElementById("fps").innerHTML=H.averageFPS;var X=(I.clientWidth+I.clientHeight+l)/3;X=(j.width+j.height+l)/3;u[0]=Math.sin(W*0.0003)*1.5*X;u[1]=Math.cos(W*0.0003)*1.5*X;u[2]=X;k.clear(k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT);L.matrix4.perspective(O,z.degToRad(60),v.clientWidth/v.clientHeight,1,5000);L.matrix4.lookAt(c,u,e,C);L.matrix4.mul(n,c,O);k.bindBuffer(k.ARRAY_BUFFER,h);k.vertexAttribPointer(Q,3,k.FLOAT,false,0,0);var T=k.getUniformLocation(D,"uMVMatrix");k.uniformMatrix4fv(T,false,n);var V=k.getUniformLocation(D,"zMax");k.uniform1f(V,l);k.drawArrays(k.TRIANGLES,0,Math.floor(b.length/3))}document.fabinpocketInit=K;document.fabinpocketUpdate3D=P;document.addEventListener("DOMContentLoaded",K)})(tdl);(function(d){function b(f){console.log("Updating...");d("#loading-container").addClass("fa fa-spinner fa-spin");document.fabinpocketUpdate3D(f);d("#loading-container").removeClass("fa fa-spinner fa-spin")}function c(){b(false)}var a=undefined;function e(){if(a!==undefined){window.clearTimeout(a)}a=window.setTimeout(c,750)}d(document).ready(function(){d("#heightmap").on("load",function(){b(true)});d(".tabs__tab").click(function(j){d(".tabs__tab").removeClass("is-active");d(this).addClass("is-active");d(".tabs__panel").removeClass("is-active");d(d(this).attr("href")).addClass("is-active");j.preventDefault();return false});d("#menu-button").click(function(j){d(".menu").toggleClass("is-active");j.preventDefault();return false});var i=window.URL||window.webkitURL;d("#file-upload").change(function(l){var j=d(this).val();var k=this.files[0];console.log("loading new image: "+j);d("#heightmap").attr("src",i.createObjectURL(k));d("#heightmap").each(function(){if(this.complete){b(true)}else{console.log("not complete")}});d(".menu").toggleClass("is-active")});d("#clear-btn").click(function(j){d(".menu").toggleClass("is-active");var k=d("#shapecanvas")[0];var l=k.getContext("2d");l.fillStyle="black";l.fillRect(0,0,k.width,k.height);e();j.preventDefault();return false});var g={};var h=d("#shapecanvas")[0].getContext("2d");function f(l){var j=d("#shapecanvas")[0];var k=j.getBoundingClientRect();l.canvasX=l.offsetX*j.width/k.width;l.canvasY=l.offsetY*j.height/k.height}d("#shapecanvas").on("touchstart mousedown",function(j){h.beginPath();h.lineWidth=10;h.strokeStyle="white";f(j);h.moveTo(j.canvasX,j.canvasY);g.started=true;e()}).on("touchmove mousemove",function(j){if(g.started){f(j);h.lineTo(j.canvasX,j.canvasY);h.stroke();e()}}).on("touchup mouseup",function(j){if(g.started){f(j);h.lineTo(j.canvasX,j.canvasY);h.stroke()}g.started=false;e()})})})(jQuery);