(function(I){const a=16;function R(){this.timeTable=[];this.currentTimeTableIndex=0;this.totalTime=a;for(var ad=0;ad<a;ad++){this.timeTable[ad]=1}this.averageFPS=0}R.prototype.update=function(ad){ad=ad*0.001;this.totalTime=this.totalTime+ad-this.timeTable[this.currentTimeTableIndex];this.timeTable[this.currentTimeTableIndex]=ad;this.currentTimeTableIndex=(this.currentTimeTableIndex+1)%a;this.averageFPS=Math.floor((1/(this.totalTime/a))+0.5)};var Z=new R();var w={zScale:1};document.FabInPocket=w;var C=w.glcanvas=document.getElementById("previewcanvas");var L;var Y;function E(ae,ad){ae.push(ad.x);ae.push(ad.y);ae.push(ad.z)}function F(ad,ae){if(ae[0].z>0||ae[1].z>0||ae[2].z>0){E(ad,ae[0]);E(ad,ae[1]);E(ad,ae[2]);E(ad,{x:ae[0].x,y:ae[0].y,z:0});E(ad,{x:ae[2].x,y:ae[2].y,z:0});E(ad,{x:ae[1].x,y:ae[1].y,z:0})}}function U(ad,ae){F(ad,[ae[0],ae[3],ae[1]]);F(ad,[ae[0],ae[2],ae[3]])}var P=document.getElementById("shapecanvas");var n=undefined;var l=document.getElementById("heightmap");function V(ai,af){for(var ad=0;ad<(af.width-1);ad++){for(var ak=0;ak<(af.height-1);ak++){var ah=ad+(ak*af.width);var aj=ai[ah];var ae=ad+((ak+1)*af.width);var ag=ai[ae];ai[ae]=Math.min(aj+1,ag)}}}function z(ai,af){for(var ae=0;ae<(af.width-1);ae++){for(var ak=af.height-1;ak>=0;ak--){var ah=ae+(ak*af.width);var aj=ai[ah];var ad=ae+((ak-1)*af.width);var ag=ai[ad];ai[ad]=Math.min(aj+1,ag)}}}function T(ah,ae){for(var ak=0;ak<(ae.height-1);ak++){for(var ad=0;ad<(ae.width-1);ad++){var ag=ad+(ak*ae.width);var aj=ah[ag];var af=ad+1+(ak*ae.width);var ai=ah[af];ah[af]=Math.min(aj+1,ai)}}}function aa(ah,ae){for(var ak=0;ak<(ae.height-1);ak++){for(var ad=(ae.width-1);ad>=0;ad--){var ag=ad+(ak*ae.width);var aj=ah[ag];var ai=ad-1+(ak*ae.width);var af=ah[ai];ah[ai]=Math.min(aj+1,af)}}}function G(ae,ad){V(ae,ad);z(ae,ad);T(ae,ad);aa(ae,ad)}function c(ae,ad,ag,ak,aj){var ah=0;var af=ak+(aj*ag.width);var am=ad[af];if(ae[af]===0){return false}for(var ao=-1;ao<=1;ao++){for(var an=-1;an<=1;an++){if(ao===0&&an===0){continue}var ai=(ak+ao)+((aj+an)*ag.width);var al=ad[ai];if(al>am){ah+=1}}}return(ah<1)}function N(ae,ad,ai,af){var aj=Math.max(ai.width,ai.height);var ah=af.length;while(ah--){af[ah]=aj}for(var ak=1;ak<(ai.height-2);ak++){for(var al=1;al<(ai.width-2);al++){var ag=al+(ak*ai.width);if(c(ae,ad,ai,al,ak)){af[ag]=0}}}}function t(am,aj,ak){var ae=document.getElementById("computedheightmapcanvas");ae.width=aj.width;ae.height=aj.height;var aj=new Image();aj.src=l.src;var ao=ae.getContext("2d");var an=new Array(am.length);var ap=0.1;var ai=am.length;while(ai--){an[ai]=(am[ai]>ap)?Math.max(aj.width,aj.height):0}G(an,aj);var ag=new Array(am.length);N(am,an,aj,ag);G(ag,aj);var af=0;var ad=ao.getImageData(0,0,aj.width,aj.height);var ah=ad.data;ai=am.length;while(ai--){var al=an[ai];al=Math.sqrt((an[ai]+ag[ai])*(an[ai]+ag[ai])-(ag[ai]*ag[ai]));if(al>af){af=al}al=ak*am[ai]/255*al;ah[4*ai]=al;ah[(4*ai)+1]=(ag[ai]===0&&am[ai]!==0)?255:al;ah[(4*ai)+2]=(ag[ai]===0&&am[ai]!==0)?0:al;ah[(4*ai)+3]=255}console.log("longest distance found: "+af);ao.putImageData(ad,0,0)}function i(al,ah){if(ah===undefined){return}var ae=al.getContext("2d");var ad=ae.getImageData(0,0,ah.width,ah.height);var af=ad.data;var aj=w.zScale;var ak=new Array();for(var ag=0;ag<af.length;ag+=4){var ai=aj*af[ag];ak.push(ai);if(n==undefined||ai>n){n=ai}}return ak}function j(ah,ag){var al=ag.width/2;var ak=ag.height/2;var aj="";aj+="solid fabinpocket\n";var af=0;while(af<ah.length){aj+=" facet normal 0.0 0.0 0.0\n  outer loop\n";aj+="    vertex "+(al+ah[af])+" "+(ak+ah[af+1])+" "+ah[af+2]+"\n";af+=3;aj+="    vertex "+(al+ah[af])+" "+(ak+ah[af+1])+" "+ah[af+2]+"\n";af+=3;aj+="    vertex "+(al+ah[af])+" "+(ak+ah[af+1])+" "+ah[af+2]+"\n";af+=3;aj+="  endloop\n endfacet\n"}aj+="ensolid fabinpocket\n";var ai=document.getElementById("export-stl");var ad=new Blob([aj],{type:"octet/stream"});var ae=window.URL.createObjectURL(ad);ai.setAttribute("href",ae)}I("#export-stl").on("click",function(){j(d,m)});function r(){var ad=document.getElementById("export-png");var ae=document.getElementById("computedheightmapcanvas");ad.href=ae.toDataURL("image/png")}I("#export-png").on("click",function(){r()});function B(){var ad=document.getElementById("export-shape");var ae=document.getElementById("shapecanvas");ad.href=ae.toDataURL("image/png")}I("#export-shape").on("click",function(){B()});function v(ah,ad){var ae=P.getContext("2d");if(ad){ah.src=l.src;P.width=ah.width;P.height=ah.height;ae.drawImage(ah,0,0);w.zScale=parseFloat(document.getElementById("heightmap").getAttribute("z-scale"));if(w.zScale===undefined){w.zScale=1}}n=undefined;var al=i(P,ah);var aj=w.zScale;console.log("zScale="+aj);t(al,ah,aj);al=i(document.getElementById("computedheightmapcanvas"),ah);var ak=new Array();for(var am=0;am<(ah.height-1);am++){for(var an=0;an<(ah.width-1);an++){var ao=al[an+(am*ah.width)];var ag=al[an+1+(am*ah.width)];var ai=al[an+((am+1)*ah.width)];var af=al[an+1+((am+1)*ah.width)];U(ak,[{x:an-ah.width/2,y:ah.height/2-am,z:ao},{x:an+1-ah.width/2,y:ah.height/2-am,z:ag},{x:an-ah.width/2,y:ah.height/2-am-1,z:ai},{x:an+1-ah.width/2,y:ah.height/2-am-1,z:af}])}}if(ak.length===0){ak=undefined}return ak}var u=480/640;var k;var d;var m;var D=new THREE.Scene();var s=new THREE.PerspectiveCamera(75,600/400,0.1,50000);var M=new THREE.WebGLRenderer({canvas:C});var q=new THREE.BoxGeometry(1,1,1);var Q=new THREE.MeshPhongMaterial({color:6842506,ambient:16777215,shininess:30,reflectivity:30});var b=new THREE.Mesh(q,Q);var y=undefined;function X(af){d=[-1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,-1,-1,1,1,-1];var ag=af?new Image():m;var ad=v(ag,af);if(ad!==undefined){d=ad}q=new THREE.BufferGeometry();var ah=new Float32Array(d.length);for(var ae=0;ae<d.length;ae++){ah[ae]=d[ae]}q.addAttribute("position",new THREE.BufferAttribute(ah,3));q.computeFaceNormals();q.computeVertexNormals();q.computeBoundingBox();if(y!=undefined){D.remove(y)}y=new THREE.Mesh(q,Q);y.castShadow=true;y.receiveShadow=true;y.position.x-=y.position.x/2;y.position.y-=y.position.y/2;D.add(y);m=ag}function O(){var ae=document.getElementById("preview-wrapper");var af=ae.offsetWidth;var ad=ae.offsetHeight;M.setSize(af,ad);s.aspect=af/ad}I(window).resize(O);var h;function S(){O();M.setClearColor(16777215,1);M.shadowMapEnabled=true;D.add(b);var af=new THREE.PlaneBufferGeometry(640,400);var ag=new THREE.MeshPhongMaterial({color:15724527});var ae=new THREE.Mesh(af,ag);ae.castShadow=true;ae.receiveShadow=true;ae.receiveShadow=true;D.add(ae);var ad=new THREE.AmbientLight(4210752);D.add(ad);h=new THREE.SpotLight(16777215);h.position.set(0,0,100);h.castShadow=true;h.shadowDarkness=0.5;h.castShadow=true;h.shadowMapWidth=512;h.shadowMapHeight=512;h.intensity=1;h.shadowDarkness=0.1;h.shadowCameraNear=true;D.add(h);s.position.x=5;s.position.y=5;s.position.z=5;s.up.set(0,0,1);s.lookAt(new THREE.Vector3(0,0,0));X(true);f(performance.now())}var H=undefined;var K=new Float32Array([0,0,1]);var W=new Float32Array(16);var e=new Float32Array(16);var A=new Float32Array([0,0,255]);var g=new Float32Array([0,0,0]);var p=new Float32Array(16);var ac=new Float32Array(16);var o=new Float32Array(16);var ab;var J=0.02;var x=undefined;function f(ae){w.stopLoop=window.requestAnimationFrame(f);if(m===undefined){return}var ad;if(H==undefined){ad=1}else{ad=ae-H}H=ae;var af=(new Date()).getTime();var ah=af-ab;ab=af;Z.update(ad);document.getElementById("fps").innerHTML=Z.averageFPS;var ag=(P.clientWidth+P.clientHeight+n)/3;ag=(m.width+m.height+n)/3;ag=ag/3;if(y!=undefined&&y.geometry!=undefined){y.geometry.computeBoundingSphere();ag=y.geometry.boundingSphere.radius}s.position.x=Math.sin(ae*0.0003)*1*ag;s.position.y=Math.cos(ae*0.0003)*1*ag;s.position.z=1.5*ag;s.lookAt(new THREE.Vector3(0,0,0));h.position.z=5*ag;M.render(D,s)}document.fabinpocketInit=S;document.fabinpocketUpdate3D=X;document.addEventListener("DOMContentLoaded",S)})(jQuery);(function(d){function b(f){console.log("Updating...");d("#loading-container").addClass("fa fa-spinner fa-spin");document.fabinpocketUpdate3D(f);d("#loading-container").removeClass("fa fa-spinner fa-spin")}function c(){b(false)}var a=undefined;function e(){if(a!==undefined){window.clearTimeout(a)}a=window.setTimeout(c,750)}d(document).ready(function(){d("#heightmap").on("load",function(){b(true)});d(".tabs__tab").click(function(m){d(".tabs__tab").removeClass("is-active");d(this).addClass("is-active");d(".tabs__panel").removeClass("is-active");d(d(this).attr("href")).addClass("is-active");m.preventDefault();return false});d("#menu-button").click(function(m){d(".menu").toggleClass("is-active");m.preventDefault();return false});var k=window.URL||window.webkitURL;d("#file-upload").change(function(o){var m=d(this).val();var n=this.files[0];console.log("loading new image: "+m);d("#heightmap").attr("src",k.createObjectURL(n));d("#heightmap").each(function(){if(this.complete){b(true)}else{console.log("not complete")}});d(".menu").toggleClass("is-active")});d("#white-pencil-btn").click(function(m){g.color="white";d(".menu").toggleClass("is-active");m.preventDefault();return false});d("#black-eraser-btn").click(function(m){g.color="black";d(".menu").toggleClass("is-active");m.preventDefault();return false});d("#clear-btn").click(function(m){d(".menu").toggleClass("is-active");var n=d("#shapecanvas")[0];var o=n.getContext("2d");o.fillStyle="black";o.fillRect(0,0,n.width,n.height);e();m.preventDefault();return false});var i={};var j=d("#shapecanvas")[0].getContext("2d");function h(o){var m=d("#shapecanvas")[0];var n=m.getBoundingClientRect();o.canvasX=o.offsetX*m.width/n.width;o.canvasY=o.offsetY*m.height/n.height}var g={size:10,color:"white",start:function(m){h(m);f(j,m);j.beginPath();j.lineWidth=g.size;j.fillStyle=g.color;j.strokeStyle=g.color;j.moveTo(m.canvasX,m.canvasY);i.started=true;e();m.preventDefault()},move:function(m){if(i.started){h(m);j.lineTo(m.canvasX,m.canvasY);j.stroke();e();m.preventDefault()}},end:function(m){if(i.started){h(m);j.lineTo(m.canvasX,m.canvasY);j.stroke();f(j,m);e();m.preventDefault()}i.started=false}};function f(n,o){var m=g.size/2;n.moveTo(o.canvasX,o.canvasY);n.beginPath();n.lineWidth=1;n.fillStyle=g.color;n.strokeStyle=g.color;n.arc(o.canvasX,o.canvasY,m,0,2*Math.PI,true);n.fill()}var l=d("#shapecanvas");l.on("mousedown",g.start).on("touchmove mousemove",g.move).on("touchup mouseup",g.end);l[0].addEventListener("touchstart",g.start);l[0].addEventListener("touchmove",g.move);l[0].addEventListener("touchen",g.end);d("#tool-size").on("change",function(m){g.size=parseFloat(d(this).val())});d("#z-scale").on("change",function(m){document.FabInPocket.zScale=parseFloat(d(this).val());e()})})})(jQuery);